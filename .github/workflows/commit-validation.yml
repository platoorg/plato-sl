name: Commit Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

jobs:
  validate-commits:
    name: Validate Commit Messages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for commit range

      - name: Set up commit range
        id: commit-range
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For PRs, validate commits in the PR
            echo "range=${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            # For pushes to main, validate the pushed commits
            echo "range=${{ github.event.before }}..${{ github.event.after }}" >> $GITHUB_OUTPUT
          fi

      - name: Make validation scripts executable
        run: |
          chmod +x scripts/validate-commits.sh
          chmod +x scripts/validate-commit-scope.sh
          chmod +x tests/test-commit-validation.sh

      - name: Run validation tests
        run: |
          ./tests/test-commit-validation.sh

      - name: Validate commits
        run: |
          ./scripts/validate-commits.sh "${{ steps.commit-range.outputs.range }}"

      - name: Comment on PR (on failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Commit validation failed**\n\nPlease ensure your commit messages follow the conventional commits format.\n\nSee [docs/commit-conventions.md](../blob/main/docs/commit-conventions.md) for detailed guidelines.\n\n**Valid examples:**\n- `add(address/fr): add French address schema`\n- `edit(geo/us): update state abbreviations`\n- `docs: update README`\n\n**Common mistakes:**\n- Missing scope for `add`, `edit`, or `remove` types\n- Invalid scope format (must be lowercase: `category/country`)\n- Using `add` for existing schemas (use `edit` instead)\n- Using `edit` for non-existent schemas (use `add` instead)'
            })
